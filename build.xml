<project name="cutplace" default="bdist_egg" basedir=".">
    <description>Buildfile for cutplace</description>

    <!-- Set global properties for this build. -->
    <property name="source" location="${basedir}/source" />
    <property name="tests.dir" location="${basedir}/tests" />
    <property name="tests-input.dir" location="${tests.dir}/input" />
    <property name="tests-input-icds.dir" location="${tests-input.dir}/icds" />
    <property name="tests-output.dir" location="${tests.dir}/output" />
    <property name="build" location="${basedir}/build" />
    <property name="dist" location="${basedir}/dist" />
    <property name="site.dir" location="${build}/site" />
    <property name="reports.dir" location="${site.dir}/reports" />
    <property name="api.dir" location="${site.dir}/api" />
    <property name="slocdata.dir" location="${basedir}/slocdata" />

    <macrodef name="pyst">
        <!-- Macro to run a setup.py command. -->
        <attribute name="command" />
        <sequential>
            <exec executable="python" failonerror="true">
                <arg value="setup.py" />
                <arg value="@{command}" />
            </exec>
        </sequential>
    </macrodef>

    <target name="develop" depends="bdist_egg" description="install current development version">
        <tstamp />
        <pyst command="develop" />
    </target>

    <target name="install" depends="bdist_egg" description="install binary distribution">
        <tstamp />
        <pyst command="install" />
    </target>

    <target name="sdist" depends="bdist_egg" description="build source distribution">
        <!-- Delete Mac OS X Finder cache files. -->
        <delete>
            <fileset defaultexcludes="false" dir="." includes="**/.DS_Store" />
        </delete>
        <exec executable="python" failonerror="true">
            <arg value="setup.py" />
            <arg value="sdist" />
            <arg value="--formats=zip" />
        </exec>
    </target>

    <target name="sdist_upload" depends="bdist_egg" description="build source distribution">
        <!-- Delete Mac OS X Finder cache files. -->
        <delete>
            <fileset defaultexcludes="false" dir="." includes="**/.DS_Store" />
        </delete>
        <exec executable="python" failonerror="true">
            <arg value="setup.py" />
            <arg value="sdist" />
            <arg value="--formats=zip" />
            <arg value="upload" />
        </exec>
    </target>

    <target name="bdist_egg" depends="docs" description="build binary distribution">
        <tstamp />
        <pyst command="bdist_egg" />
    </target>

    <target name="bdist_egg_upload" depends="docs" description="build binary distribution and upload it to PyPI">
        <tstamp />
        <exec executable="python" failonerror="true">
            <arg value="setup.py" />
            <arg value="bdist_egg" />
            <arg value="upload" />
        </exec>
    </target>

    <target name="bdist_wininst_upload" depends="docs" description="build Windows installer and upload it to PyPI">
        <tstamp />
        <exec executable="python" failonerror="true">
            <arg value="setup.py" />
            <arg value="bdist_wininst" />
            <arg value="upload" />
        </exec>
    </target>

    <target name="testdata" description="generate test data">
        <exec executable="python" failonerror="true">
            <arg path="cutplace/dev_test.py" />
            <env key="PYTHONPATH" value="${basedir}" />
        </exec>
    </target>

    <target name="test" description="run test suite">
        <exec executable="python" failonerror="false">
            <arg path="setup.py" />
            <arg value="test" />
        </exec>
    </target>

    <target name="performance" description="run performance test" depends="sitebase">
        <exec executable="nosetests" failonerror="false">
            <arg value="--with-xunit" />
            <arg value="--xunit-file" />
            <arg file="nosetests_performance.xml" />
            <arg file="tests/test_performance.py" />
        </exec>
    </target>

    <target name="clean" description="clean up">
        <!-- Delete files and folders generated by target "bdist". -->
        <pyst command="clean" />
        <delete>
            <fileset dir="." includes="**/*.pyc, **/*$py.class" />
            <fileset dir="." includes="coverage.xml, nosetests.xml, nosetests_performance.xml, flake8.txt, sloccount.sc" />
        </delete>
        <delete includeemptydirs="true">
            <fileset dir="${tests-output.dir}" includes="**/*" />
        </delete>
        <delete dir="${build}" />
        <delete dir="${slocdata.dir}" />
    </target>

    <target name="site" depends="reports, docs, api" description="build web site">
        <!-- Dummy target to invoke all dependencies. -->
    </target>

    <target name="sitebase">
        <mkdir dir="${site.dir}/images" />
        <mkdir dir="${reports.dir}" />
        <mkdir dir="${api.dir}" />
    </target>

	<target description="copy web site to github pages for publication" name="gh-pages" depends="site">
		<copy todir="../gh-pages-cutplace" overwrite="true" preservelastmodified="true">
            <fileset dir="${site.dir}">
                <exclude name=".buildinfo" />
                <exclude name=".doctrees/**" />
            </fileset>
		</copy>
	</target>
    <target description="build documentation" name="docs" depends="sitebase, testdata">
        <pyst command="docs" />
    </target>

    <target name="reports" depends="sitebase, flake8, sloccount, testdata, performance" description="build developer reports" />

    <target name="sloccount" description="build sloccount report">
        <mkdir dir="${slocdata.dir}" />
        <echo message="build sloccount report" />
        <exec executable="sloccount" failonerror="true">
            <arg value="--details" />
            <arg value="--wide" />
            <arg value="--datadir" />
            <arg path="${slocdata.dir}" />
            <arg path="${basedir}/cutplace" />
            <redirector logError="true" output="sloccount.sc">
                <outputfilterchain>
                    <linecontainsregexp>
                        <regexp pattern="^[0-9]+\t.+" />
                    </linecontainsregexp>
                </outputfilterchain>
            </redirector>
        </exec>
        <delete dir="${slocdata.dir}" />
    </target>

    <target name="flake8" description="build flake8 violations report">
        <echo message="build flake8 violations report" />
        <exec executable="tox">
            <!--
            Note: We do not use failonerror="true" because any violations results in an exit code
            of 1, which would result in the whole build to be considered failed.
            -->
            <arg value="-e" />
            <arg value="flake8" />
            <redirector output="flake8.txt" />
        </exec>
        <concat>
            <filelist files="flake8.txt"/>
        </concat>
    </target>

    <target name="api" depends="sitebase" description="build API documentation">
        <exec executable="epydoc" failonerror="true">
            <arg value="--config" />
            <arg file=".settings/epydoc.config" />
        </exec>
    </target>
</project>
