<project name="cutplace" default="bdist_egg" basedir=".">
    <description>Buildfile for cutplace</description>

    <!-- Set global properties for this build. -->
    <property name="source" location="source" />
    <property name="source-site.dir" location="${source}/site" />
    <property name="tests.dir" location="tests" />
    <property name="tests-input.dir" location="${tests.dir}/input" />
    <property name="tests-input-icds.dir" location="${tests-input.dir}/icds" />
    <property name="tests-output.dir" location="${tests.dir}/output" />
    <property name="build" location="build" />
    <property name="dist" location="dist" />
    <property name="external.dir" location="external" />
    <property name="docs.dir" location="docs" />
    <property name="site.dir" location="${build}/site" />
    <property name="reports.dir" location="${site.dir}/reports" />
    <property name="test_all.py" location="cutplace/test_all.py" />

    <xmlcatalog id="catalogs">
        <dtd location="dtds/docbook-xml/docbookx.dtd" publicId="-//OASIS//DTD DocBook XML V4.5//EN" />
        <dtd location="dtds/html4/loose.dtd" publicId="-//W3C//DTD HTML 4.01 Transitional//EN" />
        <dtd location="dtds/xhtml/xhtml1-strict.dtd" publicId="-//W3C//DTD XHTML 1.0 Strict//EN" />
        <dtd location="dtds/xhtml/xhtml1-transitional.dtd" publicId="-//W3C//DTD XHTML 1.0 Transitional//EN" />
    </xmlcatalog>

    <target name="install" depends="bdist_egg" description="install binary distribution">
        <tstamp />
        <exec executable="python">
            <arg value="setup.py" />
            <arg value="install" />
        </exec>
    </target>

    <target name="sdist" depends="bdist_egg" description="build source distribution">
        <!-- Delete Mac OS X Finder cache files. -->
        <delete>
          <fileset defaultexcludes="false" dir="." includes="**/.DS_Store"/>
        </delete>
        <exec executable="python">
            <arg value="setup.py" />
            <arg value="sdist" />
	    	<arg value="--formats=zip" />
        </exec>
    </target>

    <target name="bdist_egg" depends="docs" description="build binary distribution">
        <tstamp />
        <exec executable="python">
            <arg value="setup.py" />
            <arg value="bdist_egg" />
        </exec>
    </target>

    <target name="bdist_egg_upload" depends="docs" description="build binary distribution and upload it to PyPI">
        <tstamp />
        <exec executable="python">
            <arg value="setup.py" />
            <arg value="bdist_egg" />
            <arg value="upload" />
        </exec>
    </target>

    <target name="bdist_wininst_upload" depends="docs" description="build Windows installer and upload it to PyPI">
        <tstamp />
        <exec executable="python">
            <arg value="setup.py" />
            <arg value="bdist_wininst" />
            <arg value="upload" />
        </exec>
    </target>

	<target name="testdata" description="generate test data">
        <exec executable="python">
            <arg value="cutplace/dev_test.py" />
        </exec>
	</target>

    <target name="test" depends="testdata" description="run test suite">
        <exec executable="python" failonerror="true">
            <arg value="${test_all.py}" />
        </exec>
    </target>

    <target name="clean" description="clean up">
        <!-- Delete files and folders generated by target "bdist". -->
        <exec executable="python">
            <arg value="setup.py" />
            <arg value="clean" />
        </exec>
        <delete>
            <fileset dir="." includes="**/*.pyc, **/*$py.class"/>
        </delete>
        <delete includeemptydirs="true">
            <fileset dir="${tests-output.dir}" includes="**/*"/>
        </delete>
    </target>

    <target name="site" depends="reports, docs" description="build web site">
        <!-- Dummy target to invoke all dependencies. -->
    </target>

    <target name="sitebase">
        <mkdir dir="${site.dir}/images" />
        <mkdir dir="${reports.dir}" />
    </target>
    
    <target description="build documentation" name="docs" depends="sitebase, testdata">
        <echo message="build documentation in ${site.dir}" />
    	<exec executable="sphinx-build" failonerror="true">
    	    <!-- Use HTML builder. -->
            <arg value="-b" />
            <arg value="html" />
    	    <!-- Disable colored output. -->
            <arg value="-N" />
    	    <!--Show only warnings and errors. -->
            <arg value="-q" />
            <arg value="docs" />
            <arg value="${site.dir}" />
    	</exec>
	</target>

	<target name="reports" depends="sitebase, testdata">
        <!-- <exec executable="python" error="build-stderr.txt"> -->
        <exec executable="python">
            <!-- FIXME: Use platform independent path. --> 
            <arg value="cutplace/dev_reports.py" />
            <arg value="${reports.dir}" />
        </exec>
	</target>
</project>
